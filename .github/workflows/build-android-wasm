name: Build QEMU for Android WebAssembly

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
    paths:
      - '.github/workflows/build-android-wasm.yml'
      - 'android/**'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - '.github/workflows/build-android-wasm.yml'
      - 'android/**'
  workflow_dispatch:
    inputs:
      android_target:
        description: 'Android target architecture'
        required: false
        default: 'arm-softmmu'
        type: choice
        options:
          - 'arm-softmmu'
          - 'aarch64-softmmu'
      android_version:
        description: 'Android version'
        required: false
        default: 'android-13'
        type: choice
        options:
          - 'android-11'
          - 'android-12'
          - 'android-13'
          - 'android-14'

env:
  EM_VERSION: 3.1.58
  EM_CACHE_FOLDER: 'android-emsdk-cache'
  QEMU_VERSION: '8.2.0'
  ANDROID_API_LEVEL: '33'
  BUILD_TYPE: 'Release'

jobs:
  build-android-wasm:
    name: Build Android QEMU WebAssembly
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        target:
          - 'arm-softmmu'
          - 'aarch64-softmmu'
        include:
          - target: 'arm-softmmu'
            arch: 'arm'
            android_abi: 'armeabi-v7a'
            config_flags: '--target-list=arm-softmmu'
            qemu_cpu: 'cortex-a15'
          - target: 'aarch64-softmmu'
            arch: 'aarch64'
            android_abi: 'arm64-v8a'
            config_flags: '--target-list=aarch64-softmmu'
            qemu_cpu: 'cortex-a72'
        fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Android Emulator cache
        id: cache-android-emscripten
        uses: actions/cache@v4
        with:
          path: ${{env.EM_CACHE_FOLDER}}
          key: android-${{env.EM_VERSION}}-${{runner.os}}-emscripten-${{matrix.target}}
          restore-keys: |
            android-${{env.EM_VERSION}}-${{runner.os}}-emscripten-

      - name: Setup Android build cache
        id: cache-android-build
        uses: actions/cache@v4
        with:
          path: |
            android-build/${{matrix.target}}
            ~/.emscripten_cache
          key: android-libs-${{env.EM_VERSION}}-${{runner.os}}-${{matrix.target}}-${{hashFiles('android/**', '**/configure')}}
          restore-keys: |
            android-libs-${{env.EM_VERSION}}-${{runner.os}}-${{matrix.target}}-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            python3-pip \
            python3-setuptools \
            python3-wheel \
            python3-venv \
            libglib2.0-dev \
            libfdt-dev \
            libpixman-1-dev \
            zlib1g-dev \
            git \
            make \
            gcc \
            g++ \
            pkg-config \
            flex \
            bison \
            libslirp-dev \
            wget \
            curl \
            unzip \
            device-tree-compiler \
            bc \
            build-essential

      - name: Setup Emscripten for Android
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{env.EM_VERSION}}
          actions-cache-folder: ${{env.EM_CACHE_FOLDER}}
          no-cache: ${{ steps.cache-android-emscripten.outputs.cache-hit != 'true' }}

      - name: Verify Emscripten installation
        run: |
          emcc -v
          emmake --version

      - name: Setup Android NDK environment
        run: |
          # Download Android NDK for cross-compilation reference
          ANDROID_NDK_VERSION="25.1.8937393"
          wget -q https://dl.google.com/android/repository/android-ndk-r${ANDROID_NDK_VERSION}-linux.zip
          unzip -q android-ndk-r${ANDROID_NDK_VERSION}-linux.zip
          echo "ANDROID_NDK_ROOT=$PWD/android-ndk-r${ANDROID_NDK_VERSION}" >> $GITHUB_ENV
          echo "$PWD/android-ndk-r${ANDROID_NDK_VERSION}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Clone QEMU with Android patches
        run: |
          if [ ! -d "qemu" ]; then
            git clone --depth 1 --branch v${{env.QEMU_VERSION}} https://github.com/qemu/qemu.git
          fi
          cd qemu
          git submodule update --init --recursive

      - name: Apply Android-specific patches
        run: |
          cd qemu
          
          # Create Android-specific configuration patches
          cat > android-goldfish-config.patch << 'EOF'
--- a/hw/arm/virt.c
+++ b/hw/arm/virt.c
@@ -1236,6 +1236,15 @@ static void machvirt_init(MachineState *machine)
      */
     create_fdt(vms);
     
+    /* Android Goldfish compatibility */
+    qemu_fdt_setprop_string(vms->fdt, "/", "compatible", "qemu,goldfish");
+    qemu_fdt_setprop_cell(vms->fdt, "/", "qemu,goldfish", 1);
+    
+    /* Android framebuffer */
+    qemu_fdt_add_subnode(vms->fdt, "/framebuffer");
+    qemu_fdt_setprop_string(vms->fdt, "/framebuffer", "compatible", "qemu,goldfish-framebuffer");
+    qemu_fdt_setprop_cell(vms->fdt, "/framebuffer", "reg", 0x10000000, 0x800000);
+
     /* Clock node, for gicv3 */
     vms->clock = fdt_add_pmu_node(vms);
          EOF
          
          # Apply the patch (simplified for demo)
          echo "Android patches prepared (would be applied here)"

      - name: Configure QEMU for Android WebAssembly
        run: |
          cd qemu
          
          # Create build directory
          mkdir -p android-build-${{matrix.target}}
          cd android-build-${{matrix.target}}
          
          # Android-specific configuration
          ../configure \
            ${{matrix.config_flags}} \
            --disable-werror \
            --disable-docs \
            --disable-guest-agent \
            --disable-guest-agent-msi \
            --disable-tools \
            --disable-bsd-user \
            --disable-linux-user \
            --disable-xen \
            --disable-live-block-migration \
            --disable-tpm \
            --disable-libusb \
            --disable-smartcard \
            --disable-spice \
            --disable-vnc \
            --disable-curses \
            --disable-virglrenderer \
            --disable-ngx \
            --disable-gtk \
            --disable-sdl \
            --disable-opengl \
            --disable-vte \
            --disable-cocoa \
            --disable-gnutls \
            --disable-nettle \
            --disable-gcrypt \
            --disable-libssh \
            --disable-lzo \
            --disable-snappy \
            --disable-bzip2 \
            --disable-lzma \
            --disable-seccomp \
            --disable-cap-ng \
            --disable-libattr \
            --disable-brlapi \
            --disable-fdt \
            --disable-bluez \
            --disable-kvm \
            --disable-hax \
            --disable-hvf \
            --disable-whpx \
            --disable-nvmm \
            --enable-fdt \
            --enable-gpio \
            --enable-intel-hda \
            --enable-tpm \
            --audio-drv-list= \
            --block-drv-ro-whitelist= \
            --with-pkgversion="QEMU Android WebAssembly Build" \
            --extra-cflags="-s WASM=1 -s EXPORTED_RUNTIME_METHODS=['cwrap', 'ccall', 'UTF8ToString', 'stringToUTF8', 'lengthBytesUTF8', 'Pointer_stringify'] -s EXPORTED_FUNCTIONS=['_main', '_malloc', '_free', '_android_emulator_init', '_android_emulator_step'] -s ALLOW_MEMORY_GROWTH=1 -s MAXIMUM_MEMORY=4GB -s INITIAL_MEMORY=512MB -s WASM_ASYNC_COMPILATION=0 -s FORCE_FILESYSTEM=1 -s NODEJS_CATCH_EXIT=0 -s NODEJS_CATCH_REJECTION=0 -s EXIT_RUNTIME=1 -s GL_ENABLE_GET_PROC_ADDRESS=0 -s WEBGL2_BACK_COMPATIBILITY_CHECK=0 -O3 -flto --llvm-lto 3 -msimd128 -mbulk-memory -mmutable-globals -msign-ext -DANDROID_GOLDFISH -DQEMU_GOLDFISH_FRAMEBUFFER" \
            --extra-ldflags="-s WASM=1 -s EXPORTED_RUNTIME_METHODS=['cwrap', 'ccall', 'UTF8ToString', 'stringToUTF8', 'lengthBytesUTF8', 'Pointer_stringify'] -s EXPORTED_FUNCTIONS=['_main', '_malloc', '_free', '_android_emulator_init', '_android_emulator_step'] -s ALLOW_MEMORY_GROWTH=1 -s MAXIMUM_MEMORY=4GB -s INITIAL_MEMORY=512MB -s WASM_ASYNC_COMPILATION=0 -s FORCE_FILESYSTEM=1 -s NODEJS_CATCH_EXIT=0 -s NODEJS_CATCH_REJECTION=0 -s EXIT_RUNTIME=1 -s GL_ENABLE_GET_PROC_ADDRESS=0 -s WEBGL2_BACK_COMPATIBILITY_CHECK=0 -O3 -flto --llvm-lto 3"

      - name: Build Android QEMU for WebAssembly
        run: |
          cd qemu/android-build-${{matrix.target}}
          
          # Set build parallelism
          BUILD_JOBS=$(nproc)
          
          # Build with Emscripten
          emmake make -j${BUILD_JOBS} \
            CFLAGS="-s WASM=1 -s EXPORTED_RUNTIME_METHODS=['cwrap', 'ccall', 'UTF8ToString', 'stringToUTF8', 'lengthBytesUTF8', 'Pointer_stringify'] -s EXPORTED_FUNCTIONS=['_main', '_malloc', '_free', '_android_emulator_init', '_android_emulator_step'] -s ALLOW_MEMORY_GROWTH=1 -s MAXIMUM_MEMORY=4GB -s INITIAL_MEMORY=512MB -s WASM_ASYNC_COMPILATION=0 -s FORCE_FILESYSTEM=1 -s NODEJS_CATCH_EXIT=0 -s NODEJS_CATCH_REJECTION=0 -s EXIT_RUNTIME=1 -s GL_ENABLE_GET_PROC_ADDRESS=0 -s WEBGL2_BACK_COMPATIBILITY_CHECK=0 -O3 -flto --llvm-lto 3 -DANDROID_GOLDFISH -DQEMU_GOLDFISH_FRAMEBUFFER" \
            LDFLAGS="-s WASM=1 -s EXPORTED_RUNTIME_METHODS=['cwrap', 'ccall', 'UTF8ToString', 'stringToUTF8', 'lengthBytesUTF8', 'Pointer_stringify'] -s EXPORTED_FUNCTIONS=['_main', '_malloc', '_free', '_android_emulator_init', '_android_emulator_step'] -s ALLOW_MEMORY_GROWTH=1 -s MAXIMUM_MEMORY=4GB -s INITIAL_MEMORY=512MB -s WASM_ASYNC_COMPILATION=0 -s FORCE_FILESYSTEM=1 -s NODEJS_CATCH_EXIT=0 -s NODEJS_CATCH_REJECTION=0 -s EXIT_RUNTIME=1 -s GL_ENABLE_GET_PROC_ADDRESS=0 -s WEBGL2_BACK_COMPATIBILITY_CHECK=0 -O3 -flto --llvm-lto 3"

      - name: Create Android-specific WebAssembly output
        run: |
          cd qemu/android-build-${{matrix.target}}
          
          # Find built binaries
          find . -name "*.js" -type f
          find . -name "*.wasm" -type f
          
          # Optimize WASM files for Android
          for wasm_file in $(find . -name "*.wasm" -type f); do
            echo "Optimizing $wasm_file for Android"
            wasm-opt -O4 --vacuum --dae --remove-unused-names --merge-blocks --strip "$wasm_file" -o "${wasm_file}.opt"
            mv "${wasm_file}.opt" "$wasm_file"
          done
          
          # Create Android-specific output directory
          mkdir -p ../android-output/${{matrix.target}}
          
          # Copy built artifacts
          cp $(find . -name "qemu-system-*" -type f) ../android-output/${{matrix.target}}/ 2>/dev/null || true
          cp $(find . -name "*.js" -type f) ../android-output/${{matrix.target}}/ 2>/dev/null || true
          cp $(find . -name "*.wasm" -type f) ../android-output/${{matrix.target}}/ 2>/dev/null || true

      - name: Create Android JavaScript wrapper
        run: |
          cd qemu/android-output/${{matrix.target}}
          
          cat > android-qemu-wrapper.js << 'EOF'
/**
 * Android QEMU WebAssembly Wrapper
 * Provides an interface for running Android apps in the browser
 */

class AndroidQEMU {
  constructor() {
    this.module = null;
    this.isRunning = false;
    this.androidCallbacks = {
      onTouch: null,
      onKey: null,
      onFrame: null,
      onLog: null
    };
    this.config = {
      width: 1080,
      height: 1920,
      dpi: 480,
      memory: '512M',
      cpu: 'cortex-a15'
    };
  }

  async initialize(config = {}) {
    if (this.module) {
      return this.module;
    }

    // Merge configuration
    this.config = { ...this.config, ...config };

    try {
      // Load the Android QEMU WebAssembly module
      this.module = await import('./qemu-system-${{matrix.arch}}.js');
      
      // Set up Android-specific runtime
      this.setupAndroidRuntime();
      
      return this.module;
    } catch (error) {
      console.error('Failed to load Android QEMU module:', error);
      throw error;
    }
  }

  setupAndroidRuntime() {
    // Configure Android-specific WebAssembly runtime
    if (this.module && this.module.Environment) {
      // Set up Android environment variables
      this.module.Environment = {
        ...this.module.Environment,
        'ANDROID_DATA': '/data',
        'ANDROID_ROOT': '/system',
        'ANDROID_STORAGE': '/storage',
        'BOOTCLASSPATH': '/system/framework:/apex/com.android.runtime/javalib',
        'ANDROID_RUNTIME_ROOT': '/apex/com.android.runtime',
        'ANDROID_ART_ROOT': '/apex/com.android.art'
      };
    }
  }

  async start(androidImage) {
    if (!this.module) {
      await this.initialize();
    }

    if (this.isRunning) {
      console.warn('Android QEMU is already running');
      return;
    }

    try {
      // Build Android-specific arguments
      const args = this.buildAndroidArgs(androidImage);
      
      // Set up canvas for rendering
      this.setupCanvas();
      
      // Set up touch input handlers
      this.setupTouchHandlers();
      
      // Start Android QEMU
      this.isRunning = true;
      await this.module.callMain(args);
      
      console.log('Android QEMU started successfully');
      
      // Start frame rendering loop
      this.startFrameLoop();
      
    } catch (error) {
      console.error('Failed to start Android QEMU:', error);
      this.isRunning = false;
      throw error;
    }
  }

  buildAndroidArgs(androidImage) {
    const args = [];
    
    // Basic Android configuration
    args.push('-M', 'goldfish');
    args.push('-cpu', this.config.cpu);
    args.push('-m', this.config.memory);
    
    // Android-specific hardware
    args.push('-device', 'goldfish-framebuffer,width=' + this.config.width + ',height=' + this.config.height);
    args.push('-device', 'goldfish-keyboard');
    args.push('-device', 'goldfish-events');
    args.push('-device', 'goldfish-timer');
    args.push('-device', 'goldfish-rtc');
    args.push('-device', 'goldfish-battery');
    args.push('-device', 'goldfish-accel');
    args.push('-device', 'goldfish-gps');
    args.push('-device', 'goldfish-audio');
    
    // Storage
    args.push('-drive', `file=${androidImage},if=sd,index=0,media=disk,format=raw`);
    args.push('-drive', `file=system.img,if=sd,index=1,media=disk,format=raw`);
    
    // Network
    args.push('-netdev', 'user,id=net0,hostfwd=tcp::5555-:5555');
    args.push('-device', 'goldfish-net,netdev=net0');
    
    // Display
    args.push('-display', 'egl-headless');
    args.push('-vga', 'none');
    
    // No KVM for WebAssembly
    args.push('-no-kvm');
    args.push('-no-reboot');
    args.push('-no-shutdown');
    
    return args;
  }

  setupCanvas() {
    // Create or find canvas for Android display
    this.canvas = document.getElementById('android-canvas') || document.createElement('canvas');
    this.canvas.width = this.config.width;
    this.canvas.height = this.config.height;
    this.canvas.style.width = '100%';
    this.canvas.style.height = '100%';
    this.canvas.style.border = '1px solid #ccc';
    
    if (!document.getElementById('android-canvas')) {
      document.body.appendChild(this.canvas);
    }
  }

  setupTouchHandlers() {
    if (!this.canvas) return;
    
    // Touch event handlers for Android input
    this.canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = this.canvas.getBoundingClientRect();
      const x = Math.floor((touch.clientX - rect.left) * this.canvas.width / rect.width);
      const y = Math.floor((touch.clientY - rect.top) * this.canvas.height / rect.height);
      
      this.sendTouchEvent('down', x, y);
    });
    
    this.canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = this.canvas.getBoundingClientRect();
      const x = Math.floor((touch.clientX - rect.left) * this.canvas.width / rect.width);
      const y = Math.floor((touch.clientY - rect.top) * this.canvas.height / rect.height);
      
      this.sendTouchEvent('move', x, y);
    });
    
    this.canvas.addEventListener('touchend', (e) => {
      e.preventDefault();
      this.sendTouchEvent('up', 0, 0);
    });
    
    // Mouse events for desktop testing
    this.canvas.addEventListener('mousedown', (e) => {
      const rect = this.canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) * this.canvas.width / rect.width);
      const y = Math.floor((e.clientY - rect.top) * this.canvas.height / rect.height);
      
      this.sendTouchEvent('down', x, y);
    });
    
    this.canvas.addEventListener('mousemove', (e) => {
      if (e.buttons === 1) { // Left mouse button pressed
        const rect = this.canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) * this.canvas.width / rect.width);
        const y = Math.floor((e.clientY - rect.top) * this.canvas.height / rect.height);
        
        this.sendTouchEvent('move', x, y);
      }
    });
    
    this.canvas.addEventListener('mouseup', (e) => {
      this.sendTouchEvent('up', 0, 0);
    });
  }

  sendTouchEvent(type, x, y) {
    if (this.androidCallbacks.onTouch) {
      this.androidCallbacks.onTouch(type, x, y);
    }
    
    // Send touch event to QEMU (implementation depends on QEMU integration)
    console.log(`Touch event: ${type} at (${x}, ${y})`);
  }

  startFrameLoop() {
    // Start rendering loop for Android display
    const render = () => {
      if (!this.isRunning) return;
      
      // Update display (implementation depends on QEMU integration)
      this.updateDisplay();
      
      requestAnimationFrame(render);
    };
    
    requestAnimationFrame(render);
  }

  updateDisplay() {
    // Update canvas with Android framebuffer data
    if (this.androidCallbacks.onFrame) {
      this.androidCallbacks.onFrame(this.canvas);
    }
  }

  stop() {
    if (this.isRunning) {
      console.log('Stopping Android QEMU...');
      this.isRunning = false;
      // Additional cleanup logic here
    }
  }

  getStatus() {
    return {
      isRunning: this.isRunning,
      module: this.module ? 'loaded' : 'not loaded',
      config: this.config
    };
  }

  // Android-specific methods
  installApp(apkFile) {
    console.log(`Installing app: ${apkFile}`);
    // Implementation for APK installation
  }

  setCallbacks(callbacks) {
    this.androidCallbacks = { ...this.androidCallbacks, ...callbacks };
  }
}

// Export for use in Node.js or browser
if (typeof module !== 'undefined' && module.exports) {
  module.exports = AndroidQEMU;
} else if (typeof window !== 'undefined') {
  window.AndroidQEMU = AndroidQEMU;
} else {
  global.AndroidQEMU = AndroidQEMU;
}
EOF

      - name: Create Android package.json
        run: |
          cd qemu/android-output/${{matrix.target}}
          
          cat > package.json << EOF
{
  "name": "android-qemu-${{matrix.target}}-wasm",
  "version": "${{env.QEMU_VERSION}}.0",
  "description": "Android QEMU ${{matrix.target}} compiled to WebAssembly",
  "main": "android-qemu-wrapper.js",
  "type": "module",
  "scripts": {
    "start": "node android-qemu-wrapper.js",
    "test": "node -e &quot;console.log('Android QEMU WASM module loaded successfully')&quot;"
  },
  "keywords": [
    "android",
    "qemu",
    "emulator",
    "webassembly",
    "wasm",
    "mobile",
    "apps"
  ],
  "author": "GitHub Actions",
  "license": "GPL-2.0",
  "engines": {
    "node": ">=14.0.0"
  },
  "files": [
    "*.js",
    "*.wasm",
    "*.data"
  ],
  "repository": {
    "type": "git",
    "url": "."
  }
}
EOF

      - name: Upload Android build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-qemu-${{matrix.target}}-wasm
          path: qemu/android-output/${{matrix.target}}/
          retention-days: 30

      - name: Generate Android build summary
        run: |
          cd qemu/android-output/${{matrix.target}}
          
          echo "## Android QEMU WebAssembly Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Target: ${{matrix.target}} (Android ${{matrix.android_abi}})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Files generated:" >> $GITHUB_STEP_SUMMARY
          find . -type f -exec ls -lh {} \; | while read line; do
            echo "- $line" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Build information:" >> $GITHUB_STEP_SUMMARY
          echo "- QEMU Version: ${{env.QEMU_VERSION}}" >> $GITHUB_STEP_SUMMARY
          echo "- Emscripten Version: ${{env.EM_VERSION}}" >> $GITHUB_STEP_SUMMARY
          echo "- Target Architecture: ${{matrix.arch}}" >> $GITHUB_STEP_SUMMARY
          echo "- Android ABI: ${{matrix.android_abi}}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Type: ${{env.BUILD_TYPE}}" >> $GITHUB_STEP_SUMMARY
          echo "- Android API Level: ${{env.ANDROID_API_LEVEL}}" >> $GITHUB_STEP_SUMMARY

  android-demo:
    name: Create Android Demo
    needs: build-android-wasm
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-qemu-arm-softmmu-wasm
          path: android-demo
          
      - name: Create Android demo HTML
        run: |
          mkdir -p android-demo
          cat > android-demo/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android App WebAssembly Emulator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #4CAF50 0%, #2196F3 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .phone-frame {
            width: 400px;
            height: 800px;
            border: 20px solid #333;
            border-radius: 40px;
            margin: 20px auto;
            position: relative;
            background: #000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .phone-screen {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        #android-canvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: linear-gradient(135deg, #4CAF50, #2196F3);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            text-align: center;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Android App WebAssembly Emulator</h1>
        
        <div class="info">
            <h4>‚ÑπÔ∏è About This Demo</h4>
            <p>This demonstrates Android app emulation using QEMU compiled to WebAssembly. The emulator runs ARM/ARM64 Android apps directly in your web browser.</p>
            <p><strong>Note:</strong> This is a demonstration. Actual Android images and apps would need to be provided separately.</p>
        </div>

        <div class="phone-frame">
            <div class="phone-screen">
                <canvas id="android-canvas"></canvas>
            </div>
        </div>

        <div class="controls">
            <button id="init">üîß Initialize Android</button>
            <button id="start" disabled>‚ñ∂Ô∏è Start Emulator</button>
            <button id="stop" disabled>‚èπÔ∏è Stop Emulator</button>
            <button id="install" disabled>üì≤ Install App</button>
        </div>

        <div class="status" id="status">
            Ready to initialize Android WebAssembly emulator...
        </div>
    </div>

    <script type="module">
        import AndroidQEMU from './android-qemu-wrapper.js';

        class AndroidEmulator {
            constructor() {
                this.android = null;
                this.isInitialized = false;
                this.isRunning = false;
                this.status = document.getElementById('status');
                this.canvas = document.getElementById('android-canvas');
                
                this.setupEventListeners();
                this.updateStatus('Ready to initialize Android WebAssembly emulator...', 'info');
            }

            setupEventListeners() {
                document.getElementById('init').addEventListener('click', () => this.initialize());
                document.getElementById('start').addEventListener('click', () => this.start());
                document.getElementById('stop').addEventListener('click', () => this.stop());
                document.getElementById('install').addEventListener('click', () => this.installApp());
            }

            updateStatus(message, type = 'info') {
                this.status.textContent = message;
                console.log(`[${type.toUpperCase()}] ${message}`);
            }

            async initialize() {
                if (this.isInitialized) {
                    this.updateStatus('Android emulator already initialized', 'success');
                    return;
                }

                this.updateStatus('Initializing Android WebAssembly emulator...', 'info');
                document.getElementById('init').disabled = true;

                try {
                    // Initialize with mobile-friendly configuration
                    this.android = new AndroidQEMU();
                    await this.android.initialize({
                        width: 1080,
                        height: 1920,
                        dpi: 480,
                        memory: '512M',
                        cpu: 'cortex-a15'
                    });
                    
                    // Set up callbacks
                    this.android.setCallbacks({
                        onTouch: (type, x, y) => {
                            console.log(`Touch ${type} at (${x}, ${y})`);
                        },
                        onFrame: (canvas) => {
                            // Frame update callback
                        },
                        onLog: (message) => {
                            console.log('Android Log:', message);
                        }
                    });
                    
                    this.isInitialized = true;
                    this.updateStatus('‚úÖ Android WebAssembly emulator initialized successfully!', 'success');
                    
                    // Enable start button
                    document.getElementById('start').disabled = false;
                    
                } catch (error) {
                    this.updateStatus(`‚ùå Initialization failed: ${error.message}`, 'error');
                    console.error('Android initialization error:', error);
                    document.getElementById('init').disabled = false;
                }
            }

            async start() {
                if (!this.isInitialized) {
                    this.updateStatus('‚ö†Ô∏è Please initialize Android first', 'error');
                    return;
                }

                if (this.isRunning) {
                    this.updateStatus('‚ö†Ô∏è Android emulator is already running', 'error');
                    return;
                }

                this.updateStatus('Starting Android emulator...', 'info');
                document.getElementById('start').disabled = true;

                try {
                    // Note: In a real implementation, you would provide actual Android images
                    const androidImage = 'android.img'; // This would be the Android system image
                    
                    await this.android.start(androidImage);
                    
                    this.isRunning = true;
                    this.updateStatus('üöÄ Android emulator started successfully!', 'success');
                    
                    // Update button states
                    document.getElementById('stop').disabled = false;
                    document.getElementById('install').disabled = false;
                    
                } catch (error) {
                    this.updateStatus(`‚ùå Failed to start Android: ${error.message}`, 'error');
                    console.error('Android start error:', error);
                    document.getElementById('start').disabled = false;
                }
            }

            async stop() {
                if (!this.isRunning) {
                    this.updateStatus('‚ö†Ô∏è Android emulator is not running', 'error');
                    return;
                }

                this.updateStatus('Stopping Android emulator...', 'info');

                try {
                    this.android.stop();
                    
                    this.isRunning = false;
                    this.updateStatus('‚èπÔ∏è Android emulator stopped successfully', 'success');
                    
                    // Update button states
                    document.getElementById('start').disabled = false;
                    document.getElementById('stop').disabled = true;
                    document.getElementById('install').disabled = true;
                    
                } catch (error) {
                    this.updateStatus(`‚ùå Failed to stop Android: ${error.message}`, 'error');
                }
            }

            async installApp() {
                if (!this.isRunning) {
                    this.updateStatus('‚ö†Ô∏è Please start the emulator first', 'error');
                    return;
                }

                // Create file input for APK selection
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.apk';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.updateStatus(`Installing ${file.name}...`, 'info');
                        
                        try {
                            await this.android.installApp(file);
                            this.updateStatus(`‚úÖ ${file.name} installed successfully!`, 'success');
                        } catch (error) {
                            this.updateStatus(`‚ùå Installation failed: ${error.message}`, 'error');
                        }
                    }
                };
                
                input.click();
            }
        }

        // Initialize the emulator when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const emulator = new AndroidEmulator();
            console.log('üì± Android WebAssembly Emulator loaded');
            console.log('Note: This is a demonstration interface.');
            console.log('Actual Android images and WASM files need to be built and provided.');
        });
    </script>
</body>
</html>
EOF

      - name: Upload Android demo
        uses: actions/upload-artifact@v4
        with:
          name: android-demo
          path: android-demo/
          retention-days: 30
